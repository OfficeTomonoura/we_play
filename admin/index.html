<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理ダッシュボード | We Play 管理システム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+JP:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div id="app-sidebar"></div>
        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="header-title" style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 3px; height: 18px; background: var(--primary); border-radius: 2px;"></div>
                    <h1 style="font-size: 1.1rem; font-weight: 800; color: #fff; letter-spacing: 0.5px;">We Play
                        未来人財育成委員会 事業ポータル</h1>
                </div>
                <div class="user-profile">
                    <!-- Dynamic Profile Rendered by components.js -->
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Stats Section -->
                <section class="dashboard-section">
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <div style="width: 4px; height: 20px; background: var(--primary); border-radius: 2px;">
                            </div>
                            <h2 style="font-size: 1.2rem; font-weight: 700; color: #fff;">応募状況</h2>
                        </div>
                    </div>
                    <div class="stats-grid" id="roles-stats-container">
                        <div class="stat-card">
                            <div class="stat-icon" style="--color: #00f2ff;">
                                <i data-lucide="user-plus"></i>
                            </div>
                            <div class="stat-info">
                                <span class="label">総応募数</span>
                                <span id="stat-total" class="count">-</span>
                            </div>
                        </div>
                        <!-- Dynamic Role Stats will be inserted here -->
                    </div>
                </section>

                <!-- Charts Section -->
                <section class="dashboard-section">
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <div style="width: 4px; height: 20px; background: var(--primary); border-radius: 2px;">
                            </div>
                            <h2 style="font-size: 1.2rem; font-weight: 700; color: #fff;">統計データ</h2>
                        </div>
                    </div>
                    <div class="charts-row">
                        <div class="chart-container main-chart">
                            <h3>応募推移</h3>
                            <canvas id="registrationTrend"></canvas>
                        </div>
                        <div class="chart-container secondary-chart">
                            <h3>認知経路</h3>
                            <canvas id="referralSource"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Recent Registrations Section -->
                <section class="dashboard-section">
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <div style="width: 4px; height: 20px; background: var(--primary); border-radius: 2px;">
                            </div>
                            <h2 style="font-size: 1.2rem; font-weight: 700; color: #fff;">最近の応募</h2>
                        </div>
                        <a href="applicants.html" class="view-all" style="text-decoration: none;">すべて表示</a>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>氏名</th>
                                    <th>学校 / 学年</th>
                                    <th>第一希望</th>
                                    <th>応募日</th>
                                    <th>ステータス</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-client.js"></script>
    <script src="components.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script>
        lucide.createIcons();
        document.addEventListener('DOMContentLoaded', fetchDashboardData);

        async function fetchDashboardData() {
            if (!window.supabaseClient) return;

            try {
                // 1. Get Totals
                const { count: totalCount, error: totalErr } = await window.supabaseClient
                    .from('applicants')
                    .select('*', { count: 'exact', head: true });

                if (!totalErr) document.getElementById('stat-total').textContent = totalCount;

                // 2. Get Dynamic Role counts
                const { data: roles } = await window.supabaseClient.from('master_role').select('id, name').order('sort_order');
                const rolesContainer = document.getElementById('roles-stats-container');

                if (roles && rolesContainer) {
                    // Define some vibrant colors to rotate through
                    const colors = ['#7000ff', '#ff007a', '#ffea00', '#00ff7a', '#ffae00', '#6366f1'];

                    for (let i = 0; i < roles.length; i++) {
                        const role = roles[i];
                        const { count } = await window.supabaseClient
                            .from('applicants')
                            .select('*', { count: 'exact', head: true })
                            .eq('desired_role_1_id', role.id); // Counting only 1st preference for clarity on dashboard

                        const color = colors[i % colors.length];
                        const statCard = document.createElement('div');
                        statCard.className = 'stat-card';
                        statCard.innerHTML = `
                            <div class="stat-icon" style="--color: ${color};">
                                <i data-lucide="user"></i>
                            </div>
                            <div class="stat-info">
                                <span class="label">${role.name}希望</span>
                                <span class="count">${count || 0}</span>
                            </div>
                        `;
                        rolesContainer.appendChild(statCard);
                    }
                }

                // 3. Get Recent Applicants (新規ステータスまたは2日以内の応募をすべて表示)
                const twoDaysAgo = new Date();
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                const twoDaysAgoISO = twoDaysAgo.toISOString();

                const { data: applicants, error: appErr } = await window.supabaseClient
                    .from('applicants')
                    .select('*, r1:master_role!desired_role_1_id(name), school:master_school(name)')
                    .or(`status.eq.新規,created_at.gte.${twoDaysAgoISO}`)
                    .order('created_at', { ascending: false });

                const tbody = document.querySelector('.data-table tbody');
                if (tbody) {
                    if (!appErr && applicants && applicants.length > 0) {
                        tbody.innerHTML = '';
                        applicants.forEach(item => {
                            const date = new Date(item.created_at).toLocaleDateString();
                            const isNew = item.status === '新規';
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>
                                    <div class="user-meta">
                                        <span class="name">${item.full_name}</span>
                                        <span class="email">${item.email || '-'}</span>
                                    </div>
                                </td>
                                <td>${item.school?.name || '-'} / ${item.grade || ''}</td>
                                <td>${item.r1?.name || '-'}</td>
                                <td>${date}</td>
                                <td><span class="status-badge ${isNew ? 'new' : item.status === '選抜済' ? 'selected' : ''}">${item.status}</span></td>
                                <td><button class="action-btn" onclick="location.href='applicants.html?id=${item.id}'"><i data-lucide="more-horizontal"></i></button></td>
                            `;
                            tbody.appendChild(tr);
                        });
                        if (window.lucide) window.lucide.createIcons();
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem; color:var(--text-dim);">対応が必要な応募はありません</td></tr>';
                    }
                }

                // 4. Trend Chart (Aggregation by day)
                initTrendChart();

                // 5. Referral Chart
                initReferralChart();

            } catch (err) {
                console.error('Dashboard Error:', err);
            }
        }

        async function initReferralChart() {
            const ctx = document.getElementById('referralSource');
            if (!ctx) return;

            const { data: sources } = await window.supabaseClient.from('master_referral_source').select('id, name');
            if (!sources) return;

            const labels = [];
            const counts = [];
            const colors = ['#00f2ff', '#7000ff', '#ff007a', '#ffea00', '#00ff7a', '#ffae00', '#6366f1'];

            for (const source of sources) {
                const { count } = await window.supabaseClient
                    .from('applicants')
                    .select('*', { count: 'exact', head: true })
                    .eq('referral_source_id', source.id);

                if (count > 0) {
                    labels.push(source.name);
                    counts.push(count);
                }
            }

            const referralChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0,
                        hoverOffset: 12
                    }]
                },
                plugins: [{
                    id: 'custom-labels-and-lines',
                    afterDraw: (chart) => {
                        const { ctx } = chart;
                        ctx.save();
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const { x, y, startAngle, endAngle, outerRadius } = element;
                                const midAngle = startAngle + (endAngle - startAngle) / 2;
                                const label = chart.data.labels[index];

                                // 線を開始する座標
                                const startX = x + Math.cos(midAngle) * outerRadius;
                                const startY = y + Math.sin(midAngle) * outerRadius;

                                // 屈折点
                                const line1X = x + Math.cos(midAngle) * (outerRadius + 20);
                                const line1Y = y + Math.sin(midAngle) * (outerRadius + 20);

                                // 終点
                                const isRight = Math.cos(midAngle) > 0;
                                const line2X = line1X + (isRight ? 15 : -15);
                                const line2Y = line1Y;

                                // 線を描画
                                ctx.beginPath();
                                ctx.strokeStyle = dataset.backgroundColor[index];
                                ctx.lineWidth = 1.6;
                                ctx.moveTo(startX, startY);
                                ctx.lineTo(line1X, line1Y);
                                ctx.lineTo(line2X, line2Y);
                                ctx.stroke();

                                // 文字列を描画（改行対応）
                                ctx.fillStyle = '#fff';
                                ctx.font = 'bold 11px "Outfit", "Noto Sans JP", sans-serif';
                                ctx.textAlign = isRight ? 'left' : 'right';
                                ctx.textBaseline = 'middle';

                                // ( ) が含まれる場合は改行
                                const lines = label.includes('(') ? label.split(/(?=\()/) : [label];
                                const lineHeight = 13;
                                const textX = line2X + (isRight ? 8 : -8);

                                lines.forEach((lineText, index) => {
                                    const yOffset = (index - (lines.length - 1) / 2) * lineHeight;
                                    ctx.fillText(lineText.trim(), textX, line2Y + yOffset);
                                });
                            });
                        });
                        ctx.restore();
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 75,
                            right: 75,
                            top: 25,
                            bottom: 25
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true },
                        datalabels: { display: false }
                    },
                    cutout: '65%'
                }
            });
        }

        async function initTrendChart() {
            const ctx = document.getElementById('registrationTrend');
            if (!ctx) return;

            // Simple aggregation for the last 7 days
            const labels = [];
            const counts = [];

            // Generate labels for last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push((date.getMonth() + 1) + '/' + date.getDate());

                const dateStr = date.toISOString().split('T')[0];

                // Cumulative: count all records up to the end of this day
                const { count } = await window.supabaseClient
                    .from('applicants')
                    .select('*', { count: 'exact', head: true })
                    .lte('created_at', dateStr + 'T23:59:59');

                counts.push(count || 0);
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '累計応募数',
                        data: counts,
                        backgroundColor: 'rgba(0, 242, 255, 0.4)',
                        borderColor: '#00f2ff',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'rgba(255,255,255,0.5)', precision: 0, stepSize: 1 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.5)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#00f2ff',
                            bodyColor: '#fff',
                            padding: 10,
                            displayColors: false
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>