<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プレミアム・イベント参加申込 | WE PLAY</title>
    <meta name="description" content="未来を共創する次世代イベントの参加申込フォーム。最先端の体験をあなたに。">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+JP:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .required-badge {
            background: rgba(255, 75, 75, 0.1);
            color: #ff4b4b;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 700;
            vertical-align: middle;
        }

        .phone-groups {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phone-groups input {
            text-align: center;
            flex: 1;
        }

        .phone-groups .separator {
            color: rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        .error-text {
            color: #ff4b4b;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="background-overlay"></div>

    <main class="container">
        <section class="form-wrapper">
            <header class="form-header">
                <div class="logo">
                    <span class="logo-text">一般社団法人福山青年会議所</span>
                </div>
                <h1>We Play 未来人財育成委員会</h1>
                <h2>映画作ろうぜ！！<br>〜地域で育む協働の絆〜</h2>
                <p>参加をご希望の方は、以下のフォームより必要事項をご入力ください。</p>
            </header>

            <form id="registrationForm" class="registration-form" novalidate>
                <!-- Hidden fields for LINE ID Linkage -->
                <input type="hidden" id="line_user_id" name="line_user_id" value="">
                <input type="hidden" id="line_display_name" name="line_display_name" value="">
                <input type="hidden" id="line_picture_url" name="line_picture_url" value="">
                <div class="form-group">
                    <label for="name">
                        <i data-lucide="user"></i> お名前<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" id="name" name="applicant_name" placeholder="山田 太郎" required>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="name-kana">
                        <i data-lucide="user"></i> お名前（ふりがな）<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" id="name-kana" name="applicant_kana" placeholder="やまだ たろう"
                            pattern="^[ぁ-んー\s]+$" title="ひらがなで入力してください" autocomplete="off" required>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="gender">
                        <i data-lucide="user"></i> 性別<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="gender" name="gender" required>
                            <option value="" disabled selected>選択してください</option>
                            <option value="male">男</option>
                            <option value="female">女</option>
                            <option value="other">選択しない</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="school">
                        <i data-lucide="graduation-cap"></i> 学校名<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="school" name="school_id" required>
                            <option value="" disabled selected>読み込み中...</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="grade">
                        <i data-lucide="hash"></i> 学年<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="grade" name="grade" required>
                            <option value="" disabled selected>選択してください</option>
                            <option value="1">1年生</option>
                            <option value="2">2年生</option>
                            <option value="3">3年生</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="role-1">
                        <i data-lucide="star"></i> 第1希望役職<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="role-1" name="role-1" class="role-select" required>
                            <option value="" disabled selected>読み込み中...</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="role-2">
                        <i data-lucide="star"></i> 第2希望役職<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="role-2" name="role-2" class="role-select" required>
                            <option value="" disabled selected>読み込み中...</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="role-3">
                        <i data-lucide="star"></i> 第3希望役職<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="role-3" name="role-3" class="role-select" required>
                            <option value="" disabled selected>読み込み中...</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="referral">
                        <i data-lucide="megaphone"></i> 何で知ったか<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <select id="referral" name="referral" class="referral-select" required>
                            <option value="" disabled selected>読み込み中...</option>
                        </select>
                        <i data-lucide="chevron-down" class="select-icon"></i>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group" id="referral-other-group" style="display: none;">
                    <label for="referral-other">
                        <i data-lucide="edit-3"></i> その他の理由<span class="required-badge" style="display: none;"
                            id="referral-other-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <textarea id="referral-other" name="referral-other" rows="2"
                            placeholder="具体的にご記入ください"></textarea>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">
                        <i data-lucide="mail"></i> メールアドレス<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="email" id="email" name="email" placeholder="example@weplay.com" required>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone-1">
                        <i data-lucide="phone"></i> 電話番号<span class="required-badge">必須</span>
                    </label>
                    <div class="input-wrapper phone-groups">
                        <input type="tel" id="phone-1" name="phone_1" placeholder="090" pattern="\d*" required>
                        <span class="separator">-</span>
                        <input type="tel" id="phone-2" name="phone_2" placeholder="1234" pattern="\d*" required>
                        <span class="separator">-</span>
                        <input type="tel" id="phone-3" name="phone_3" placeholder="5678" pattern="\d*" required>
                        <span class="focus-border"></span>
                    </div>
                    <input type="hidden" id="phone" name="phone">
                </div>

                <div class="form-group">
                    <label for="message">
                        <i data-lucide="message-square"></i> ご要望・メッセージ
                    </label>
                    <div class="input-wrapper">
                        <textarea id="message" name="message" rows="4" placeholder="ご質問や特別なリクエストがあればご記入ください"></textarea>
                        <span class="focus-border"></span>
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label class="custom-checkbox">
                        <input type="checkbox" name="privacy" required>
                        <span class="checkmark"></span>
                        <span class="label-text"><a href="#">プライバシーポリシー</a>に同意する</span>
                    </label>
                </div>

                <button type="submit" class="submit-button">
                    <span>送信する</span>
                    <i data-lucide="arrow-right"></i>
                </button>
            </form>

            <div id="successMessage" class="success-overlay" style="display: none;">
                <div class="success-content">
                    <div class="success-icon">
                        <i data-lucide="check-circle-2"></i>
                    </div>
                    <h2>申し込み完了</h2>
                    <p>ありがとうございます。確認メールをお送りしました。</p>
                    <button type="button" class="close-btn" onclick="location.reload()">閉じる</button>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="assets/js/supabase-client.js"></script>
    <script src="assets/js/form.js"></script>
    <script>
        lucide.createIcons();

        // LIFF Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            const liffId = "2009015373-QGkjtgDJ";
            try {
                await liff.init({ liffId: liffId });

                // Check environment
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';

                if (liff.isLoggedIn()) {
                    setLiffData();
                } else if (!isLocal) {
                    // Force login if in production (HTTPS)
                    liff.login();
                }

                // Load Master Data
                loadMasterData();
            } catch (err) {
                console.warn('LIFF Initialization failed:', err);
            }
        });

        async function loadMasterData() {
            if (!window.supabaseClient) return;
            try {
                // Load Schools
                const { data: schools, error: schoolErr } = await window.supabaseClient
                    .from('master_school')
                    .select('id, name')
                    .order('sort_order', { ascending: true });

                if (schoolErr) throw schoolErr;
                const schoolSelect = document.getElementById('school');
                if (schoolSelect) {
                    let html = '<option value="" disabled selected>選択してください</option>';
                    schools.forEach(s => {
                        html += `<option value="${s.id}">${s.name}</option>`;
                    });
                    schoolSelect.innerHTML = html;
                }

                // Load Roles
                const { data: roles, error: roleError } = await window.supabaseClient
                    .from('master_role')
                    .select('id, name')
                    .order('sort_order', { ascending: true });

                if (roleError) throw roleError;

                const roleSelects = document.querySelectorAll('.role-select');
                roleSelects.forEach(select => {
                    let html = '<option value="" disabled selected>選択してください</option>';
                    roles.forEach(role => {
                        html += `<option value="${role.id}">${role.name}</option>`;
                    });
                    select.innerHTML = html;
                });

                // Add mutual exclusion logic
                const updateRoleOptions = () => {
                    const selectedValues = Array.from(roleSelects).map(s => s.value).filter(v => v);

                    roleSelects.forEach(select => {
                        const currentValue = select.value;
                        Array.from(select.options).forEach(option => {
                            if (!option.value) return; // Skip placeholder
                            // Disable if selected elsewhere, unless it's the current selection for this dropdown
                            option.disabled = selectedValues.includes(option.value) && option.value !== currentValue;
                        });
                    });
                };

                roleSelects.forEach(select => {
                    select.addEventListener('change', updateRoleOptions);
                });

                // Load Referral Sources
                const { data: referrals, error: refError } = await window.supabaseClient
                    .from('master_referral_source')
                    .select('id, name')
                    .order('sort_order', { ascending: true });

                if (refError) throw refError;

                const refSelect = document.getElementById('referral');
                if (refSelect) {
                    let html = '<option value="" disabled selected>選択してください</option>';
                    referrals.forEach(ref => {
                        html += `<option value="${ref.id}" data-name="${ref.name}">${ref.name}</option>`;
                    });
                    refSelect.innerHTML = html;

                    // Re-bind the "Other" logic since the elements are now dynamic
                    refSelect.addEventListener('change', () => {
                        const selectedOption = refSelect.options[refSelect.selectedIndex];
                        const referralOtherGroup = document.getElementById('referral-other-group');
                        const referralOtherInput = document.getElementById('referral-other');
                        const referralOtherBadge = document.getElementById('referral-other-badge');

                        if (selectedOption && selectedOption.getAttribute('data-name') === 'その他') {
                            if (referralOtherGroup) referralOtherGroup.style.display = 'block';
                            if (referralOtherInput) referralOtherInput.required = true;
                            if (referralOtherBadge) referralOtherBadge.style.display = 'inline-block';
                        } else {
                            if (referralOtherGroup) referralOtherGroup.style.display = 'none';
                            if (referralOtherInput) {
                                referralOtherInput.required = false;
                                referralOtherInput.value = '';
                            }
                            if (referralOtherBadge) referralOtherBadge.style.display = 'none';
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load master data:', err);
                alert('マスタデータの読み込みに失敗しました。');
            }
        }

        async function setLiffData() {
            try {
                const profile = await liff.getProfile();
                const userIdField = document.getElementById('line_user_id');
                const nameField = document.getElementById('line_display_name');
                const picField = document.getElementById('line_picture_url');

                if (userIdField) userIdField.value = profile.userId;
                if (nameField) nameField.value = profile.displayName;
                if (picField) picField.value = profile.pictureUrl;

                console.log('LIFF User Linked:', profile.userId);

                // Check if already applied
                await checkRedirect(profile.userId);

            } catch (err) {
                console.error('Error getting profile:', err);
            }
        }

        async function checkRedirect(userId) {
            if (!window.supabaseClient) return;
            try {
                // Determine base path for redirect (LP is usually at root or ../index.html relative to this file?)
                // register.html is in root (same level as index.html).

                const { data, error } = await window.supabaseClient
                    .from('applicants')
                    .select('id')
                    .eq('line_user_id', userId)
                    .maybeSingle();

                if (data) {
                    // Already applied, redirect to LP
                    console.log('Already applied, redirecting to LP...');
                    window.location.href = 'index.html'; // Adjust if needed
                }
            } catch (e) {
                console.warn('Check redirect failed', e);
            }
        }
    </script>
</body>

</html>